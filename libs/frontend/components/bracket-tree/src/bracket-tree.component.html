<section class="block w-full">
  <div class="tournament-bracket overflow-auto p-6 rounded-lg">
    @if (bracketRounds()) {
      <!-- Tournament Bracket Layout inspired by Toernooi.nl -->
      <div class="flex items-start justify-start">
        <div class="flex justify-start items-start min-w-max" [style.gap]="columnGap() + 'px'">
          @for (round of bracketRounds(); track round.name; let roundIndex = $index; let isLast = $last) {
            <div class="flex flex-col items-center" [style.width.px]="columnWidth()">
              <!-- Round Header -->
              <div class="text-center mb-8">
                <h4 class="text-base font-semibold text-primary-700 px-4 py-2 bg-primary-50 rounded-lg border border-primary-200">
                  {{ round.name }}
                </h4>
              </div>

              <!-- Round Matches -->
              <div class="flex flex-col items-center relative" [style.margin-top.px]="getVerticalOffset(roundIndex)">
                @for (game of round.games; track game.id; let gameIndex = $index) {
                  <div class="relative" [style.margin-bottom.px]="spacing()[roundIndex]">
                    <!-- Match Box -->
                    <div
                      class="border-2 border-surface rounded-lg overflow-hidden transition-all duration-200"
                      [class.border-primary-400]="isGameCompleted(game)"
                      [style.width.px]="matchBoxWidth()"
                      [style.height.px]="matchBoxHeight()"
                    >
                      <!-- Team 1 -->
                      <div
                        class="flex items-center justify-between px-4 py-3 border-b border-surface"
                        [class.bg-highlight]="game.winner === 1"
                        [class.font-semibold]="game.winner === 1"
                        [class.text-color-emphasis]="game.winner === 1"
                      >
                        <span class="flex-1 text-sm overflow-hidden text-ellipsis whitespace-nowrap">
                          @let teamName1 = getTeamName(game, 1);
                          @if (isBye(game) && !teamName1) {
                            <span class="text-surface-500 italic">Bye</span>
                          } @else if (teamName1) {
                            {{ teamName1 }}
                          } @else {
                            <span class="text-surface-500 italic">TBD</span>
                          }
                        </span>
                        <span class="text-sm font-mono font-bold ml-3 text-surface-700">
                          {{ getTeamScore(game, 1) || '—' }}
                        </span>
                      </div>

                      <!-- Team 2 -->
                      <div
                        class="flex items-center justify-between px-4 py-3"
                        [class.bg-highlight]="game.winner === 2"
                        [class.font-semibold]="game.winner === 2"
                        [class.text-color-emphasis]="game.winner === 2"
                      >
                        <span class="flex-1 text-sm overflow-hidden text-ellipsis whitespace-nowrap">
                          @let teamName2 = getTeamName(game, 2);
                          @if (isBye(game) && !teamName2) {
                            <span class="text-surface-500 italic">Bye</span>
                          } @else if (teamName2) {
                            {{ teamName2 }}
                          } @else {
                            \n <span class="text-surface-500 italic">TBD</span>
                          }
                        </span>
                        <span class="text-sm font-mono font-bold ml-3 text-surface-700">
                          {{ getTeamScore(game, 2) || '—' }}
                        </span>
                      </div>
                    </div>

                    <!-- Connection Lines to Next Round -->
                    @if (!isLast) {
                      <!-- Horizontal line from match to next column -->
                      <div
                        class="bg-surface-400 absolute top-1/2"
                        [style.left.px]="columnWidth()"
                        [style.width.px]="connectorLength()"
                        [style.height.px]="2"
                        [style.transform]="'translateY(calc(-50% + 1px))'"
                      ></div>

                      <!-- Vertical connecting lines for match pairs -->
                      @if (gameIndex % 2 === 0 && gameIndex + 1 < round.games.length) {
                        <!-- Connect this match with the one below it -->
                        @let verticalDistance = matchBoxHeight() + spacing()[roundIndex];
                        <div
                          class="bg-surface-400 absolute"
                          [style.left.px]="columnWidth() + connectorLength()"
                          [style.top.px]="matchBoxHeight() / 2 + 1"
                          [style.width.px]="2"
                          [style.height.px]="verticalDistance"
                        ></div>
                        <!-- Horizontal line to next round -->
                        <div
                          class="bg-surface-400 absolute"
                          [style.left.px]="columnWidth() + connectorLength()"
                          [style.top.px]="matchBoxHeight() / 2 + verticalDistance / 2"
                          [style.width.px]="connectorLength()"
                          [style.height.px]="2"
                        ></div>
                      }
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    } @else {
      <!-- Generate tree from standings if no explicit tree structure -->
      <div class="text-center py-8">
        <div class="mb-4">
          <i class="pi pi-sitemap text-4xl text-muted-color"></i>
        </div>
        <h4 class="text-lg font-medium mb-2">Tournament Tree</h4>
        @if (standings().length > 0) {
          <div class="max-w-md mx-auto">
            <h5 class="font-semibold mb-4">Current Rankings:</h5>
            <div class="space-y-2">
              @for (standing of standings() | slice: 0 : 4; track standing.id) {
                <div class="flex justify-between items-center p-3 bg-primary-50 rounded border border-surface-200">
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 bg-primary-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                      {{ standing.position }}
                    </span>
                    <span class="font-medium">
                      @if (standing.player1 || standing.player2) {
                        <div class="flex flex-col">
                          @if (standing.player1) {
                            <span>{{ standing.player1.fullName }}</span>
                          }
                          @if (standing.player2) {
                            <span>{{ standing.player2.fullName }}</span>
                          }
                        </div>
                      } @else {
                        <span>Team {{ standing.teamId | slice: 0 : 8 }}</span>
                      }
                    </span>
                  </div>
                  <span class="font-bold text-primary-600">{{ standing.points || 0 }} pts</span>
                </div>
              }
            </div>
          </div>
        } @else {
          <p class="text-surface-500">No tournament data available yet.</p>
        }
      </div>
    }
  </div>
</section>
