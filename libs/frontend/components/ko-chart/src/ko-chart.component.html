<section class="ko-tree">
  <h3 class="flex items-center gap-2 text-xl font-semibold mb-6">
    <i class="pi pi-sitemap text-primary-500"></i>
    Knockout Tree
  </h3>

  <div class="tournament-bracket overflow-auto p-6 rounded-lg">
    @if (bracketRounds()) {
      <!-- Tournament Bracket Layout inspired by Toernooi.nl -->
      <div class="bracket-container">
        <div class="flex justify-start items-start min-w-max" [style.gap]="columnGap() + 'px'">
          @for (round of bracketRounds(); track round.name; let roundIndex = $index; let isLast = $last) {
            <div class="bracket-round" [style.width.px]="columnWidth()">
              <!-- Round Header -->
              <div class="round-header text-center mb-8">
                <h4 class="text-base font-semibold text-primary-700 dark:text-primary-300 px-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-lg border border-primary-200 dark:border-primary-800">
                  {{ round.name }}
                </h4>
              </div>
              
              <!-- Round Matches -->
              <div class="matches-column relative" [style.margin-top.px]="getVerticalOffset(roundIndex)">
                @for (game of round.games; track game.id; let gameIndex = $index) {
                  <div class="match-wrapper relative" [style.margin-bottom.px]="spacing()[roundIndex]">
                    <!-- Match Box -->
                    <div class="match-box bg-surface-0 dark:bg-surface-800 border-2 border-surface-200 dark:border-surface-700 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-200" [class.border-primary-400]="isGameCompleted(game)" [style.width.px]="matchBoxWidth()" [style.height.px]="matchBoxHeight()">
                      <!-- Team 1 -->
                      <div class="team-row flex items-center justify-between px-4 py-3 border-b border-surface dark:border-surface" [class.bg-green-50]="game.winner === 1" [class.dark:bg-green-900/20]="game.winner === 1" [class.font-semibold]="game.winner === 1" [class.text-green-800]="game.winner === 1" [class.dark:text-green-200]="game.winner === 1">
                        <span class="team-name text-sm truncate flex-1">
                          @let teamName1 = getTeamName(game, 1);
                          @if (isBye(game) && !teamName1) {
                            <span class="text-surface-500 italic">Bye</span>
                          } @else if (teamName1) {
                            {{ teamName1 }}
                          } @else {
                            <span class="text-surface-500 italic">TBD</span>
                          }
                        </span>
                        <span class="team-score text-sm font-mono font-bold ml-3 text-surface-700 dark:text-surface-200">
                          {{ getTeamScore(game, 1) || '—' }}
                        </span>
                      </div>
                      
                      <!-- Team 2 -->
                      <div class="team-row flex items-center justify-between px-4 py-3" [class.bg-green-50]="game.winner === 2" [class.dark:bg-green-900/20]="game.winner === 2" [class.font-semibold]="game.winner === 2" [class.text-green-800]="game.winner === 2" [class.dark:text-green-200]="game.winner === 2">
                        <span class="team-name text-sm truncate flex-1">
                          @let teamName2 = getTeamName(game, 2);
                          @if (isBye(game) && !teamName2) {
                            <span class="text-surface-500 italic">Bye</span>
                          } @else if (teamName2) {
                            {{ teamName2 }}
                          } @else {\n                            <span class="text-surface-500 italic">TBD</span>
                          }
                        </span>
                        <span class="team-score text-sm font-mono font-bold ml-3 text-surface-700 dark:text-surface-200">
                          {{ getTeamScore(game, 2) || '—' }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Connection Lines to Next Round -->
                    @if (!isLast) {
                      <!-- Horizontal line from match to next column -->
                      <div class="connector-line absolute top-1/2 -translate-y-1/2" [style.left.px]="columnWidth()" [style.width.px]="connectorLength()" [style.height.px]="2"></div>
                      
                      <!-- Vertical connecting lines for match pairs -->
                      @if (gameIndex % 2 === 0 && gameIndex + 1 < round.games.length) {
                        <!-- Connect this match with the one below it -->
                        @let verticalDistance = matchBoxHeight() + spacing()[roundIndex];
                        <div class="vertical-connector absolute" 
                             [style.left.px]="columnWidth() + connectorLength()" 
                             [style.top.px]="matchBoxHeight() / 2" 
                             [style.width.px]="2" 
                             [style.height.px]="verticalDistance"></div>
                        <!-- Horizontal line to next round -->
                        <div class="horizontal-connector absolute" 
                             [style.left.px]="columnWidth() + connectorLength()" 
                             [style.top.px]="matchBoxHeight() / 2 + verticalDistance / 2 - 1" 
                             [style.width.px]="connectorLength()" 
                             [style.height.px]="2"></div>
                      }
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    } @else {
      <!-- Generate tree from standings if no explicit tree structure -->
      <div class="text-center py-8">
        <div class="mb-4">
          <i class="pi pi-sitemap text-4xl text-muted-color"></i>
        </div>
        <h4 class="text-lg font-medium mb-2">Tournament Tree</h4>
        @if (standings().length > 0) {
          <div class="max-w-md mx-auto">
            <h5 class="font-semibold mb-4">Current Rankings:</h5>
            <div class="space-y-2">
              @for (standing of standings() | slice: 0 : 4; track standing.id) {
                <div class="flex justify-between items-center p-3 bg-highlight rounded border">
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 bg-primary text-primary-contrast rounded-full flex items-center justify-center text-sm font-bold">
                      {{ standing.position }}
                    </span>
                    <span class="font-medium">
                      @if (standing.player1 || standing.player2) {
                        <div class="flex flex-col">
                          @if (standing.player1) {
                            <span>{{ standing.player1.fullName }}</span>
                          }
                          @if (standing.player2) {
                            <span>{{ standing.player2.fullName }}</span>
                          }
                        </div>
                      } @else {
                        <span>Team {{ standing.teamId | slice: 0 : 8 }}</span>
                      }
                    </span>
                  </div>
                  <span class="font-bold text-primary">{{ standing.points || 0 }} pts</span>
                </div>
              }
            </div>
          </div>
        } @else {
          <p class="text-muted-color">No tournament data available yet.</p>
        }
      </div>
    }
  </div>
</section>