<div class="recent-games-container">
  @if (!loading()) {
    @for (game of games(); track game.id) {
      <div class="game-card rounded-border border border-surface mb-3 overflow-hidden">
        <!-- Header: Event/Draw name + Teams for competition -->
        <div class="flex items-center justify-between gap-2 px-4 py-2 bg-highlight text-sm">
          <div class="flex items-center gap-2 min-w-0">
            @if (game?.tournamentDraw?.name) {
              <a
                [routerLink]="[
                  '/tournament',
                  game?.tournamentDraw?.tournamentSubEvent?.tournamentEvent?.id,
                  'sub-events',
                  game?.tournamentDraw?.tournamentSubEvent?.id,
                  'draws',
                  game?.tournamentDraw?.id,
                ]"
                class="font-medium text-color no-underline hover:text-primary-600 truncate"
              >
                {{ game?.tournamentDraw?.name }}
              </a>
            } @else if (game?.competitionEncounter?.drawCompetition?.name) {
              <a
                [routerLink]="[
                  '/competition',
                  game?.competitionEncounter?.drawCompetition?.competitionSubEvent?.competitionEvent?.id,
                  'sub-events',
                  game?.competitionEncounter?.drawCompetition?.competitionSubEvent?.id,
                  'draws',
                  game?.competitionEncounter?.drawCompetition?.id,
                ]"
                class="font-medium text-color no-underline hover:text-primary-600 truncate"
              >
                {{ game?.competitionEncounter?.drawCompetition?.name }}
              </a>
            } @else {
              <span class="font-medium text-color">{{ game?.gameType }}</span>
            }
            @if (isCompetitionGame(game)) {
              <span class="text-muted-color">-</span>
              <span class="text-muted-color truncate">
                {{ getTeamName(game, 1) }} vs {{ getTeamName(game, 2) }}
              </span>
            }
          </div>
          <p-chip [label]="game?.gameType" styleClass="text-xs" />
        </div>

        <!-- Game Content -->
        <div class="px-4 py-3">
          <!-- Team 1 -->
          <div class="flex items-center gap-3 mb-2">
            <div class="flex-1 min-w-0">
              @for (membership of game?.gamePlayerMemberships; track membership?.id) {
                @if (membership?.team === 1) {
                  <div class="flex items-center gap-1">
                    @if (!isCurrentPlayer(membership?.gamePlayer?.id || '')) {
                      <a
                        [routerLink]="['/players', membership?.gamePlayer?.id]"
                        class="text-sm text-color no-underline hover:text-primary-600 truncate"
                      >
                        {{ membership?.gamePlayer?.fullName }}
                      </a>
                    } @else {
                      <span class="text-sm font-bold text-primary truncate">
                        <i class="pi pi-user text-xs text-primary-500 ml-1"></i>
                        {{ membership?.gamePlayer?.fullName }}
                      </span>
                    }
                    @if (getPlayerLevel(game, membership?.gamePlayer?.id || ''); as level) {
                      <span class="text-xs text-muted-color">({{ level }})</span>
                    }
                  </div>
                }
              }
            </div>
            <!-- Scores -->
            <div class="flex items-center gap-2">
              @if (game.winner === 1) {
                <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
              } @else if (game.winner === 2) {
                <div class="w-2.5 h-2.5 rounded-full bg-red-500 opacity-50"></div>
              }
              <div class="flex items-center gap-1 text-sm font-medium tabular-nums">
                @if (isSetPlayed(game?.set1Team1, game?.set1Team2)) {
                  <span [class.text-green-600]="getSetWinner(game?.set1Team1, game?.set1Team2) === 1" [class.font-bold]="getSetWinner(game?.set1Team1, game?.set1Team2) === 1">
                    {{ game?.set1Team1 }}
                  </span>
                }
                @if (isSetPlayed(game?.set2Team1, game?.set2Team2)) {
                  <span [class.text-green-600]="getSetWinner(game?.set2Team1, game?.set2Team2) === 1" [class.font-bold]="getSetWinner(game?.set2Team1, game?.set2Team2) === 1">
                    {{ game?.set2Team1 }}
                  </span>
                }
                @if (isSetPlayed(game?.set3Team1, game?.set3Team2)) {
                  <span [class.text-green-600]="getSetWinner(game?.set3Team1, game?.set3Team2) === 1" [class.font-bold]="getSetWinner(game?.set3Team1, game?.set3Team2) === 1">
                    {{ game?.set3Team1 }}
                  </span>
                }
              </div>
            </div>
          </div>

          <!-- Team 2 -->
          <div class="flex items-center gap-3">
            <div class="flex-1 min-w-0">
              @for (membership of game?.gamePlayerMemberships; track membership?.id) {
                @if (membership?.team === 2) {
                  <div class="flex items-center gap-1">
                    @if (!isCurrentPlayer(membership?.gamePlayer?.id || '')) {
                      <a
                        [routerLink]="['/players', membership?.gamePlayer?.id]"
                        class="text-sm text-color no-underline hover:text-primary-600 truncate"
                      >
                        {{ membership?.gamePlayer?.fullName }}
                      </a>
                    } @else {
                      <span class="text-sm font-bold text-primary truncate">
                        <i class="pi pi-user text-xs text-primary-500 ml-1"></i>
                        {{ membership?.gamePlayer?.fullName }}
                      </span>
                    }
                    @if (getPlayerLevel(game, membership?.gamePlayer?.id || ''); as level) {
                      <span class="text-xs text-muted-color">({{ level }})</span>
                    }
                  </div>
                }
              }
            </div>
            <!-- Scores -->
            <div class="flex items-center gap-2">
              @if (game.winner === 2) {
                <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
              } @else if (game.winner === 1) {
                <div class="w-2.5 h-2.5 rounded-full bg-red-500 opacity-50"></div>
              }
              <div class="flex items-center gap-1 text-sm font-medium tabular-nums">
                @if (isSetPlayed(game?.set1Team1, game?.set1Team2)) {
                  <span [class.text-green-600]="getSetWinner(game?.set1Team1, game?.set1Team2) === 2" [class.font-bold]="getSetWinner(game?.set1Team1, game?.set1Team2) === 2">
                    {{ game?.set1Team2 }}
                  </span>
                }
                @if (isSetPlayed(game?.set2Team1, game?.set2Team2)) {
                  <span [class.text-green-600]="getSetWinner(game?.set2Team1, game?.set2Team2) === 2" [class.font-bold]="getSetWinner(game?.set2Team1, game?.set2Team2) === 2">
                    {{ game?.set2Team2 }}
                  </span>
                }
                @if (isSetPlayed(game?.set3Team1, game?.set3Team2)) {
                  <span [class.text-green-600]="getSetWinner(game?.set3Team1, game?.set3Team2) === 2" [class.font-bold]="getSetWinner(game?.set3Team1, game?.set3Team2) === 2">
                    {{ game?.set3Team2 }}
                  </span>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Footer: Date and Event -->
        <div class="flex items-center gap-3 px-4 py-2 bg-highlight-emphasis text-xs text-muted-color">
          <div class="flex items-center gap-1">
            <i class="pi pi-calendar"></i>
            <span>{{ game?.playedAt | dayjsFormat: 'ddd DD-MM-YYYY HH:mm' }}</span>
          </div>
          @if (game?.tournamentDraw?.tournamentSubEvent?.tournamentEvent?.name) {
            <div class="flex items-center gap-1">
              <i class="pi pi-map-marker"></i>
              <a
                [routerLink]="['/tournament', game?.tournamentDraw?.tournamentSubEvent?.tournamentEvent?.id]"
                class="text-muted-color no-underline hover:text-primary-600"
              >
                {{ game?.tournamentDraw?.tournamentSubEvent?.tournamentEvent?.name }}
              </a>
            </div>
          } @else if (game?.competitionEncounter?.drawCompetition?.competitionSubEvent?.competitionEvent?.name) {
            <div class="flex items-center gap-1">
              <i class="pi pi-map-marker"></i>
              <a
                [routerLink]="['/competition', game?.competitionEncounter?.drawCompetition?.competitionSubEvent?.competitionEvent?.id]"
                class="text-muted-color no-underline hover:text-primary-600"
              >
                {{ game?.competitionEncounter?.drawCompetition?.competitionSubEvent?.competitionEvent?.name }}
              </a>
            </div>
          }
          @if (getCurrentPlayerPoints(game) !== 0) {
            <div class="ml-auto flex items-center gap-1">
              <span
                [class.text-green-600]="getCurrentPlayerPoints(game) > 0"
                [class.text-red-600]="getCurrentPlayerPoints(game) < 0"
              >
                {{ formatPoints(getCurrentPlayerPoints(game)) }} pts
              </span>
            </div>
          }
        </div>
      </div>
    } @empty {
      <div class="p-8 text-center">
        <i class="pi pi-search text-4xl text-muted-color mb-4"></i>
        <h3 class="text-lg font-semibold text-color mb-2">{{ 'all.game.recent.noGamesFound' | translate }}</h3>
        <p class="text-muted-color text-sm">{{ 'all.game.recent.noPlayerGamesDescription' | translate }}</p>
      </div>
    }

    <!-- Infinite scroll sentinel for large screens -->
    @if (!isMobile() && hasMore() && games().length > 0) {
      <div #scrollSentinel class="h-1"></div>
    }

    <!-- Load more button for mobile -->
    @if (isMobile() && hasMore() && games().length > 0) {
      <div class="flex justify-center mt-4">
        <p-button
          [label]="'all.game.common.loadMore' | translate"
          [loading]="loadingMore()"
          (onClick)="loadMore()"
          [outlined]="true"
          icon="pi pi-plus"
        />
      </div>
    }

    <!-- Loading more skeletons -->
    @if (loadingMore()) {
      @for (i of [1, 2, 3]; track i) {
        <div class="rounded-border border border-surface-200 mb-3 overflow-hidden">
          <div class="flex items-center justify-between gap-2 px-4 py-2 bg-highlight">
            <p-skeleton width="6rem" height="1rem" />
            <p-skeleton width="2rem" height="1.25rem" borderRadius="1rem" />
          </div>
          <div class="px-4 py-3 space-y-2">
            <div class="flex items-center justify-between">
              <p-skeleton width="10rem" height="0.875rem" />
              <p-skeleton width="4rem" height="0.875rem" />
            </div>
            <div class="flex items-center justify-between">
              <p-skeleton width="8rem" height="0.875rem" />
              <p-skeleton width="4rem" height="0.875rem" />
            </div>
          </div>
          <div class="flex items-center gap-3 px-4 py-2 bg-highlight-emphasis">
            <p-skeleton width="10rem" height="0.75rem" />
          </div>
        </div>
      }
    }
  } @else {
    <!-- Initial loading skeletons -->
    @for (i of [1, 2, 3, 4, 5, 6]; track i) {
      <div class="rounded-border border border-surface mb-3 overflow-hidden">
        <div class="flex items-center justify-between gap-2 px-4 py-2 bg-highlight">
          <p-skeleton width="6rem" height="1rem" />
          <p-skeleton width="2rem" height="1.25rem" borderRadius="1rem" />
        </div>
        <div class="px-4 py-3 space-y-2">
          <div class="flex items-center justify-between">
            <p-skeleton width="10rem" height="0.875rem" />
            <p-skeleton width="4rem" height="0.875rem" />
          </div>
          <div class="flex items-center justify-between">
            <p-skeleton width="8rem" height="0.875rem" />
            <p-skeleton width="4rem" height="0.875rem" />
          </div>
        </div>
        <div class="flex items-center gap-3 px-4 py-2 bg-highlight-emphasis">
          <p-skeleton width="10rem" height="0.75rem" />
        </div>
      </div>
    }
  }
</div>
