<div class="flex flex-col gap-6">
  <!-- Phase Stepper Section -->
  <div class="bg-card rounded-border border border-card overflow-hidden">
    <!-- Header -->
    <div class="bg-card-header px-6 py-4 border-b border-card">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
          <i class="pi pi-flag text-primary text-lg"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-color m-0">{{ 'all.tournament.admin.settings.phase' | translate }}</h3>
          <p class="text-sm text-muted-color m-0">{{ 'all.tournament.admin.settings.phaseDescription' | translate }}</p>
        </div>
      </div>
    </div>

    <!-- Stepper Content -->
    <div class="p-6">
      <p-stepper [value]="currentPhaseIndex() + 1" [linear]="true">
        <p-step-list>
          @for (step of phaseSteps; track step.phase; let i = $index) {
            <p-step [value]="i + 1">
              <ng-template #content let-activateCallback="activateCallback" let-value="value">
                <button
                  class="bg-transparent border-0 inline-flex flex-col items-center gap-3 cursor-default p-2 rounded-lg transition-all duration-200 hover:bg-surface-100 dark:hover:bg-surface-800"
                  [pTooltip]="step.description | translate"
                  tooltipPosition="bottom"
                >
                  <span
                    class="rounded-full w-12 h-12 inline-flex items-center justify-center transition-all duration-300 shadow-sm"
                    [ngClass]="{
                      'bg-primary text-primary-contrast shadow-md': value <= currentPhaseIndex() + 1,
                      'bg-surface-100 dark:bg-surface-700 text-muted-color border-2 border-surface-300 dark:border-surface-600': value > currentPhaseIndex() + 1
                    }"
                  >
                    <i [class]="step.icon" class="text-lg"></i>
                  </span>
                  <span
                    class="text-xs font-semibold text-center max-w-24 leading-tight"
                    [ngClass]="{
                      'text-primary': value <= currentPhaseIndex() + 1,
                      'text-muted-color': value > currentPhaseIndex() + 1
                    }"
                  >
                    {{ step.label | translate }}
                  </span>
                </button>
              </ng-template>
            </p-step>
          }
        </p-step-list>
      </p-stepper>

      <!-- Phase Navigation -->
      <div class="flex gap-3 mt-6 justify-center pt-4 border-t border-card">
        <p-button
          [label]="'all.tournament.admin.settings.previousPhase' | translate"
          icon="pi pi-arrow-left"
          severity="secondary"
          [outlined]="true"
          [disabled]="!canGoBack() || updating()"
          [loading]="updating()"
          (click)="goBackPhase()"
        />
        <p-button
          [label]="'all.tournament.admin.settings.nextPhase' | translate"
          icon="pi pi-arrow-right"
          iconPos="right"
          [disabled]="!canAdvance() || updating()"
          [loading]="updating()"
          (click)="advancePhase()"
        />
      </div>
    </div>
  </div>

  <!-- Tournament Settings Form -->
  <div class="bg-card rounded-border border border-card overflow-hidden">
    <!-- Header -->
    <div class="bg-card-header px-6 py-4 border-b border-card">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
          <i class="pi pi-cog text-primary text-lg"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-color m-0">{{ 'all.tournament.admin.settings.general' | translate }}</h3>
          <p class="text-sm text-muted-color m-0">{{ 'all.tournament.admin.settings.generalDescription' | translate }}</p>
        </div>
      </div>
    </div>

    <!-- Form Content -->
    <div class="p-6">
      <form [formGroup]="settingsForm" (ngSubmit)="saveSettings()">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Tournament Name -->
          <div class="flex flex-col gap-2 lg:col-span-2">
            <label for="name" class="text-sm font-medium text-color">
              {{ 'all.tournament.admin.settings.name' | translate }}
              <span class="text-red-500">*</span>
            </label>
            <input
              pInputText
              id="name"
              formControlName="name"
              class="w-full lg:max-w-xl"
              [placeholder]="'all.tournament.admin.settings.namePlaceholder' | translate"
            />
          </div>

          <!-- Tournament Dates -->
          <div class="flex flex-col gap-2">
            <label for="tournamentDates" class="text-sm font-medium text-color">
              <i class="pi pi-calendar mr-2 text-muted-color"></i>
              {{ 'all.tournament.admin.settings.tournamentDates' | translate }}
            </label>
            <p-datepicker
              id="tournamentDates"
              formControlName="tournamentDates"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              selectionMode="range"
              [readonlyInput]="true"
              styleClass="w-full"
              [placeholder]="'all.tournament.admin.settings.tournamentDatesPlaceholder' | translate"
            />
            <small class="text-muted-color text-xs">
              {{ 'all.tournament.admin.settings.tournamentDatesHelp' | translate }}
            </small>
          </div>

          <!-- Enrollment Dates -->
          <div class="flex flex-col gap-2">
            <label for="enrollmentDates" class="text-sm font-medium text-color">
              <i class="pi pi-user-plus mr-2 text-muted-color"></i>
              {{ 'all.tournament.admin.settings.enrollmentDates' | translate }}
            </label>
            <p-datepicker
              id="enrollmentDates"
              formControlName="enrollmentDates"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              selectionMode="range"
              [readonlyInput]="true"
              styleClass="w-full"
              [placeholder]="'all.tournament.admin.settings.enrollmentDatesPlaceholder' | translate"
            />
            <small class="text-muted-color text-xs">
              {{ 'all.tournament.admin.settings.enrollmentDatesHelp' | translate }}
            </small>
          </div>

          <!-- Toggles Section -->
          <div class="lg:col-span-2 pt-4 border-t border-card">
            <p class="text-sm font-medium text-color mb-4">{{ 'all.tournament.admin.settings.options' | translate }}</p>
            <div class="flex flex-wrap gap-6">
              <div class="bg-card-header flex items-center gap-3 px-4 py-3 rounded-lg border border-card">
                <p-checkbox formControlName="official" [binary]="true" inputId="official" />
                <label for="official" class="text-sm text-color cursor-pointer">
                  {{ 'all.tournament.admin.settings.official' | translate }}
                </label>
              </div>

              <div class="bg-card-header flex items-center gap-3 px-4 py-3 rounded-lg border border-card">
                <p-checkbox formControlName="allowGuestEnrollments" [binary]="true" inputId="allowGuestEnrollments" />
                <label for="allowGuestEnrollments" class="text-sm text-color cursor-pointer">
                  {{ 'all.tournament.admin.settings.guestEnrollment' | translate }}
                </label>
              </div>

              <div class="bg-card-header flex items-center gap-3 px-4 py-3 rounded-lg border border-card">
                <p-checkbox formControlName="schedulePublished" [binary]="true" inputId="schedulePublished" />
                <label for="schedulePublished" class="text-sm text-color cursor-pointer">
                  {{ 'all.tournament.admin.enrollments.schedulePublished' | translate }}
                </label>
              </div>
            </div>
          </div>
        </div>

        @if (updateError()) {
          <p-message severity="error" [text]="updateError()!" styleClass="mt-6 w-full" />
        }

        <div class="flex justify-end mt-6 pt-4 border-t border-surface-200 dark:border-surface-700">
          <p-button
            type="submit"
            [label]="'all.button.save' | translate"
            icon="pi pi-save"
            [loading]="updating()"
            [disabled]="settingsForm.invalid || updating()"
          />
        </div>
      </form>
    </div>
  </div>

  <!-- Sub-Events Management -->
  <div class="bg-white dark:bg-surface-900 rounded-border border border-surface-200 dark:border-surface-700 overflow-hidden">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-surface-200 dark:border-surface-700 bg-surface-50 dark:bg-surface-800">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
            <i class="pi pi-th-large text-primary text-lg"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-color m-0">{{ 'all.tournament.admin.settings.subEvents' | translate }}</h3>
            <p class="text-sm text-muted-color m-0">{{ 'all.tournament.admin.settings.subEventsDescription' | translate }}</p>
          </div>
        </div>
        <p-button
          [label]="'all.tournament.admin.settings.addSubEvent' | translate"
          icon="pi pi-plus"
          size="small"
          (click)="openAddSubEvent()"
        />
      </div>
    </div>

    <!-- Sub-Events Content -->
    <div class="p-6">
      @if (tournament().tournamentSubEvents?.length) {
        <div class="overflow-x-auto">
          <p-table
            [value]="tournament().tournamentSubEvents!"
            [tableStyle]="{ 'min-width': '50rem' }"
            styleClass="p-datatable-sm"
          >
            <ng-template pTemplate="header">
              <tr class="text-sm">
                <th class="font-semibold">{{ 'all.tournament.admin.settings.subEventName' | translate }}</th>
                <th class="font-semibold">{{ 'all.tournament.admin.settings.gameType' | translate }}</th>
                <th class="font-semibold text-center">{{ 'all.tournament.admin.settings.minLevel' | translate }}</th>
                <th class="font-semibold text-center">{{ 'all.tournament.admin.settings.maxLevel' | translate }}</th>
                <th class="font-semibold text-center">{{ 'all.tournament.admin.settings.maxEntries' | translate }}</th>
                <th class="font-semibold text-center">{{ 'all.tournament.admin.settings.waitingList' | translate }}</th>
                <th class="font-semibold text-center" style="width: 7rem">{{ 'all.tournament.admin.settings.actions' | translate }}</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-subEvent>
              <tr class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                <td>
                  <span class="font-medium text-color">{{ subEvent.name }}</span>
                </td>
                <td>
                  <p-tag
                    [value]="getGameTypeLabel(subEvent.gameType)"
                    [severity]="subEvent.gameType === 'S' ? 'info' : subEvent.gameType === 'D' ? 'success' : 'warn'"
                    [rounded]="true"
                  />
                </td>
                <td class="text-center">
                  @if (subEvent.minLevel) {
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-surface-100 dark:bg-surface-700 text-sm font-semibold text-color">
                      {{ subEvent.minLevel }}
                    </span>
                  } @else {
                    <span class="text-muted-color">—</span>
                  }
                </td>
                <td class="text-center">
                  @if (subEvent.maxLevel) {
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-surface-100 dark:bg-surface-700 text-sm font-semibold text-color">
                      {{ subEvent.maxLevel }}
                    </span>
                  } @else {
                    <span class="text-muted-color">—</span>
                  }
                </td>
                <td class="text-center">
                  @if (subEvent.maxEntries) {
                    <span class="text-color font-medium">{{ subEvent.maxEntries }}</span>
                  } @else {
                    <span class="text-muted-color text-xs">∞</span>
                  }
                </td>
                <td class="text-center">
                  @if (subEvent.waitingListEnabled) {
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30">
                      <i class="pi pi-check text-green-600 dark:text-green-400 text-sm"></i>
                    </span>
                  } @else {
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-surface-100 dark:bg-surface-700">
                      <i class="pi pi-minus text-muted-color text-sm"></i>
                    </span>
                  }
                </td>
                <td>
                  <div class="flex gap-1 justify-center">
                    <p-button
                      icon="pi pi-pencil"
                      severity="secondary"
                      [text]="true"
                      [rounded]="true"
                      size="small"
                      pTooltip="Edit"
                      tooltipPosition="top"
                      (click)="openEditSubEvent(subEvent)"
                    />
                    <p-button
                      icon="pi pi-trash"
                      severity="danger"
                      [text]="true"
                      [rounded]="true"
                      size="small"
                      pTooltip="Delete"
                      tooltipPosition="top"
                      (click)="deleteSubEvent(subEvent)"
                    />
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      } @else {
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <div class="w-16 h-16 rounded-full bg-surface-100 dark:bg-surface-700 flex items-center justify-center mb-4">
            <i class="pi pi-inbox text-2xl text-muted-color"></i>
          </div>
          <p class="text-muted-color mb-4">{{ 'all.tournament.admin.settings.noSubEvents' | translate }}</p>
          <p-button
            [label]="'all.tournament.admin.settings.addSubEvent' | translate"
            icon="pi pi-plus"
            size="small"
            [outlined]="true"
            (click)="openAddSubEvent()"
          />
        </div>
      }
    </div>
  </div>

  <!-- Sub-Event Dialog -->
  <p-dialog
    [(visible)]="showSubEventDialog"
    [modal]="true"
    [style]="{ width: '480px' }"
    [header]="(editingSubEvent() ? 'all.tournament.admin.settings.editSubEvent' : 'all.tournament.admin.settings.addSubEvent') | translate"
    [draggable]="false"
    [resizable]="false"
  >
    <form [formGroup]="subEventForm" class="flex flex-col gap-5">
      <div class="flex flex-col gap-2">
        <label for="subEventName" class="text-sm font-medium text-color">
          {{ 'all.tournament.admin.settings.subEventName' | translate }}
          <span class="text-red-500">*</span>
        </label>
        <input
          pInputText
          id="subEventName"
          formControlName="name"
          class="w-full"
        />
      </div>

      <div class="flex flex-col gap-2">
        <label for="gameType" class="text-sm font-medium text-color">
          {{ 'all.tournament.admin.settings.gameType' | translate }}
          <span class="text-red-500">*</span>
        </label>
        <p-select
          id="gameType"
          formControlName="gameType"
          [options]="gameTypeOptions"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full"
        />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="flex flex-col gap-2">
          <label for="minLevel" class="text-sm font-medium text-color">
            {{ 'all.tournament.admin.settings.minLevel' | translate }}
          </label>
          <p-inputNumber
            id="minLevel"
            formControlName="minLevel"
            [min]="1"
            [max]="12"
            [showButtons]="true"
            styleClass="w-full"
          />
        </div>

        <div class="flex flex-col gap-2">
          <label for="maxLevel" class="text-sm font-medium text-color">
            {{ 'all.tournament.admin.settings.maxLevel' | translate }}
          </label>
          <p-inputNumber
            id="maxLevel"
            formControlName="maxLevel"
            [min]="1"
            [max]="12"
            [showButtons]="true"
            styleClass="w-full"
          />
        </div>
      </div>
      <small class="text-muted-color text-xs -mt-2">{{ 'all.tournament.admin.settings.levelHelp' | translate }}</small>

      <div class="flex flex-col gap-2">
        <label for="maxEntries" class="text-sm font-medium text-color">
          {{ 'all.tournament.admin.settings.maxEntries' | translate }}
        </label>
        <p-inputNumber
          id="maxEntries"
          formControlName="maxEntries"
          [min]="2"
          [showButtons]="true"
          styleClass="w-full"
        />
        <small class="text-muted-color text-xs">{{ 'all.tournament.admin.settings.maxEntriesHelp' | translate }}</small>
      </div>

      <div class="flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-50 dark:bg-surface-800 border border-surface-200 dark:border-surface-700">
        <p-checkbox formControlName="waitingListEnabled" [binary]="true" inputId="waitingListEnabled" />
        <label for="waitingListEnabled" class="text-sm text-color cursor-pointer">
          {{ 'all.tournament.admin.settings.waitingListEnabled' | translate }}
        </label>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <div class="flex gap-3 justify-end">
        <p-button
          [label]="'all.button.cancel' | translate"
          severity="secondary"
          [outlined]="true"
          (click)="showSubEventDialog.set(false)"
        />
        <p-button
          [label]="'all.button.save' | translate"
          icon="pi pi-check"
          (click)="saveSubEvent()"
          [loading]="updating()"
          [disabled]="subEventForm.invalid || updating()"
        />
      </div>
    </ng-template>
  </p-dialog>
</div>
