<div class="bg-card rounded-border border border-card overflow-hidden">
  <!-- Header -->
  <div class="px-6 py-4 border-b border-card bg-card-header">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
          <i class="pi pi-th-large text-primary text-lg"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-color m-0">{{ 'all.tournament.admin.settings.subEvents' | translate }}</h3>
          <p class="text-sm text-muted-color m-0">{{ 'all.tournament.admin.settings.subEventsDescription' | translate }}</p>
        </div>
      </div>
      <p-button
        [label]="'all.tournament.admin.settings.addSubEvent' | translate"
        icon="pi pi-plus"
        size="small"
        (click)="openAddSubEvent()"
      />
    </div>
  </div>

  <!-- Sub-Events Content -->
  <div class="p-6">
    @if (tournament().tournamentSubEvents?.length) {
      <div class="overflow-x-auto">
        <p-table
          [value]="tournament().tournamentSubEvents!"
          [tableStyle]="{ 'min-width': '50rem' }"
          class="p-datatable-sm"
          [globalFilterFields]="['name', 'eventType', 'gameType']"
          #dt
        >
          <ng-template pTemplate="header">
            <tr class="text-sm">
              <th class="font-semibold">
                <div class="flex items-center justify-between gap-2">
                  {{ 'all.tournament.admin.settings.subEventName' | translate }}
                  <p-columnFilter type="text" field="name" display="menu" class="ml-auto" />
                </div>
              </th>
              <th class="font-semibold">
                <div class="flex items-center justify-between gap-2">
                  {{ 'all.tournament.admin.settings.eventType' | translate }}
                  <p-columnFilter field="eventType" matchMode="equals" display="menu" class="ml-auto">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-select
                        [ngModel]="value"
                        [options]="eventTypeOptions"
                        (ngModelChange)="filter($event)"
                        placeholder="Any"
                        optionLabel="label"
                        optionValue="value"
                      >
                        <ng-template let-option pTemplate="item">
                          {{ option.label | translate }}
                        </ng-template>
                        <ng-template let-option pTemplate="selectedItem">
                          {{ option.label | translate }}
                        </ng-template>
                      </p-select>
                    </ng-template>
                  </p-columnFilter>
                </div>
              </th>
              <th class="font-semibold">
                <div class="flex items-center justify-between gap-2">
                  {{ 'all.tournament.admin.settings.gameType' | translate }}
                  <p-columnFilter field="gameType" matchMode="equals" display="menu" class="ml-auto">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-select
                        [ngModel]="value"
                        [options]="gameTypeOptions"
                        (ngModelChange)="filter($event)"
                        placeholder="Any"
                        optionLabel="label"
                        optionValue="value"
                      >
                        <ng-template let-option pTemplate="item">
                          {{ option.label | translate }}
                        </ng-template>
                        <ng-template let-option pTemplate="selectedItem">
                          {{ option.label | translate }}
                        </ng-template>
                      </p-select>
                    </ng-template>
                  </p-columnFilter>
                </div>
              </th>
              <th class="font-semibold text-center">
                <div class="flex items-center justify-center gap-2">
                  {{ 'all.tournament.admin.settings.minLevel' | translate }}
                  <p-columnFilter type="numeric" field="minLevel" display="menu" />
                </div>
              </th>
              <th class="font-semibold text-center">
                <div class="flex items-center justify-center gap-2">
                  {{ 'all.tournament.admin.settings.maxLevel' | translate }}
                  <p-columnFilter type="numeric" field="maxLevel" display="menu" />
                </div>
              </th>
              <th class="font-semibold text-center">
                <div class="flex items-center justify-center gap-2">
                  {{ 'all.tournament.admin.settings.maxEntries' | translate }}
                  <p-columnFilter type="numeric" field="maxEntries" display="menu" />
                </div>
              </th>
              <th class="font-semibold text-center">
                <div class="flex items-center justify-between gap-2">
                  {{ 'all.tournament.admin.settings.waitingList' | translate }}
                  <p-columnFilter field="waitingListEnabled" matchMode="equals" display="menu" [showMatchModes]="false" class="ml-auto">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-select
                        [ngModel]="value"
                        [options]="[{label: 'Yes', value: true}, {label: 'No', value: false}]"
                        (ngModelChange)="filter($event)"
                        placeholder="Any"
                        optionLabel="label"
                        optionValue="value"
                      />
                    </ng-template>
                  </p-columnFilter>
                </div>
              </th>
              <th class="font-semibold text-center" style="width: 7rem">{{ 'all.tournament.admin.settings.actions' | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-subEvent>
            <tr class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
              <td>
                <span class="font-medium text-color">{{ subEvent.name }}</span>
              </td>
              <td>
                @if (subEvent.eventType) {
                  <p-tag
                    [value]="getEventTypeLabel(subEvent.eventType) | translate"
                    severity="contrast"
                    [rounded]="true"
                  />
                } @else {
                  <span class="text-muted-color">—</span>
                }
              </td>
              <td>
                <p-tag
                  [value]="getGameTypeLabel(subEvent.gameType) | translate"
                  severity="contrast"
                  [rounded]="true"
                />
              </td>
              <td class="text-center">
                @if (subEvent.minLevel) {
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-surface-100 dark:bg-surface-700 text-sm font-semibold text-color">
                    {{ subEvent.minLevel }}
                  </span>
                } @else {
                  <span class="text-muted-color">—</span>
                }
              </td>
              <td class="text-center">
                @if (subEvent.maxLevel) {
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-surface-100 dark:bg-surface-700 text-sm font-semibold text-color">
                    {{ subEvent.maxLevel }}
                  </span>
                } @else {
                  <span class="text-muted-color">—</span>
                }
              </td>
              <td class="text-center">
                @if (subEvent.maxEntries) {
                  <span class="text-color font-medium">{{ subEvent.maxEntries }}</span>
                } @else {
                  <span class="text-muted-color text-xs">∞</span>
                }
              </td>
              <td class="text-center">
                @if (subEvent.waitingListEnabled) {
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30">
                    <i class="pi pi-check text-green-600 dark:text-green-400 text-sm"></i>
                  </span>
                } @else {
                  <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-surface-100 dark:bg-surface-700">
                    <i class="pi pi-minus text-muted-color text-sm"></i>
                  </span>
                }
              </td>
              <td>
                <div class="flex gap-1 justify-center">
                  <p-button
                    icon="pi pi-pencil"
                    severity="secondary"
                    [text]="true"
                    [rounded]="true"
                    size="small"
                    pTooltip="Edit"
                    tooltipPosition="top"
                    (click)="openEditSubEvent(subEvent)"
                  />
                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    [text]="true"
                    [rounded]="true"
                    size="small"
                    pTooltip="Delete"
                    tooltipPosition="top"
                    (click)="deleteSubEvent(subEvent)"
                  />
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    } @else {
      <div class="flex flex-col items-center justify-center py-12 text-center">
        <div class="w-16 h-16 rounded-full bg-surface-100 dark:bg-surface-700 flex items-center justify-center mb-4">
          <i class="pi pi-inbox text-2xl text-muted-color"></i>
        </div>
        <p class="text-muted-color mb-4">{{ 'all.tournament.admin.settings.noSubEvents' | translate }}</p>
        <p-button
          [label]="'all.tournament.admin.settings.addSubEvent' | translate"
          icon="pi pi-plus"
          size="small"
          [outlined]="true"
          (click)="openAddSubEvent()"
        />
      </div>
    }
  </div>
</div>

<!-- Sub-Event Dialog -->
<p-dialog
  [(visible)]="showSubEventDialog"
  [modal]="true"
  [style]="{ width: '480px' }"
  [header]="(editingSubEvent() ? 'all.tournament.admin.settings.editSubEvent' : 'all.tournament.admin.settings.addSubEvent') | translate"
  [draggable]="false"
  [resizable]="false"
>
  <form [formGroup]="subEventForm" class="flex flex-col gap-5">
    <div class="flex flex-col gap-2">
      <label for="subEventName" class="text-sm font-medium text-color">
        {{ 'all.tournament.admin.settings.subEventName' | translate }}
        <span class="text-red-500">*</span>
      </label>
      <input
        pInputText
        id="subEventName"
        formControlName="name"
        class="w-full"
      />
    </div>

    <div class="flex flex-col gap-2">
      <label for="eventType" class="text-sm font-medium text-color">
        {{ 'all.tournament.admin.settings.eventType' | translate }}
        <span class="text-red-500">*</span>
      </label>
      <p-select
        id="eventType"
        formControlName="eventType"
        [options]="eventTypeOptions"
        optionLabel="label"
        optionValue="value"
        class="w-full"
      >
        <ng-template let-option pTemplate="item">
          {{ option.label | translate }}
        </ng-template>
        <ng-template let-option pTemplate="selectedItem">
          {{ option.label | translate }}
        </ng-template>
      </p-select>
    </div>

    <div class="flex flex-col gap-2">
      <label for="gameType" class="text-sm font-medium text-color">
        {{ 'all.tournament.admin.settings.gameType' | translate }}
        <span class="text-red-500">*</span>
      </label>
      <p-select
        id="gameType"
        formControlName="gameType"
        [options]="gameTypeOptions"
        optionLabel="label"
        optionValue="value"
        class="w-full"
      >
        <ng-template let-option pTemplate="item">
          {{ option.label | translate }}
        </ng-template>
        <ng-template let-option pTemplate="selectedItem">
          {{ option.label | translate }}
        </ng-template>
      </p-select>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="flex flex-col gap-2">
        <label for="minLevel" class="text-sm font-medium text-color">
          {{ 'all.tournament.admin.settings.minLevel' | translate }}
        </label>
        <p-inputNumber
          id="minLevel"
          formControlName="minLevel"
          [min]="1"
          [max]="12"
          [showButtons]="true"
          styleClass="w-full"
        />
      </div>

      <div class="flex flex-col gap-2">
        <label for="maxLevel" class="text-sm font-medium text-color">
          {{ 'all.tournament.admin.settings.maxLevel' | translate }}
        </label>
        <p-inputNumber
          id="maxLevel"
          formControlName="maxLevel"
          [min]="1"
          [max]="12"
          [showButtons]="true"
          styleClass="w-full"
        />
      </div>
    </div>
    <small class="text-muted-color text-xs -mt-2">{{ 'all.tournament.admin.settings.levelHelp' | translate }}</small>

    <div class="flex flex-col gap-2">
      <label for="maxEntries" class="text-sm font-medium text-color">
        {{ 'all.tournament.admin.settings.maxEntries' | translate }}
      </label>
      <p-inputNumber
        id="maxEntries"
        formControlName="maxEntries"
        [min]="2"
        [showButtons]="true"
        styleClass="w-full"
      />
      <small class="text-muted-color text-xs">{{ 'all.tournament.admin.settings.maxEntriesHelp' | translate }}</small>
    </div>

    <div class="flex items-center gap-3 px-4 py-3 rounded-lg bg-surface-50 dark:bg-surface-800 border border-surface-200 dark:border-surface-700">
      <p-checkbox formControlName="waitingListEnabled" [binary]="true" inputId="waitingListEnabled" />
      <label for="waitingListEnabled" class="text-sm text-color cursor-pointer">
        {{ 'all.tournament.admin.settings.waitingListEnabled' | translate }}
      </label>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex gap-3 justify-end">
      <p-button
        [label]="'all.button.cancel' | translate"
        severity="secondary"
        [outlined]="true"
        (click)="closeDialog()"
      />
      <p-button
        [label]="'all.button.save' | translate"
        icon="pi pi-check"
        (click)="saveSubEvent()"
        [loading]="updating()"
        [disabled]="subEventForm.invalid || updating()"
      />
    </div>
  </ng-template>
</p-dialog>
