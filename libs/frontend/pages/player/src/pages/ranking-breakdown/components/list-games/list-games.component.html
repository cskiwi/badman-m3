<!-- Toolbar Section -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 px-4 py-3 bg-highlight border-b border-surface">
  <!-- Filter Toggles -->
  <div class="flex flex-wrap items-center gap-2">
    <span class="text-sm font-medium text-muted-color mr-2">
      <i class="pi pi-filter text-xs mr-1"></i>
      {{ 'all.ranking.breakdown.filters' | translate }}:
    </span>
    <p-togglebutton
      [(ngModel)]="filter.controls.includedUpgrade.value"
      onLabel="{{ 'all.ranking.breakdown.usedForUpgrade' | translate }}: {{ lostGamesUpgrade() }}"
      offLabel="{{ 'all.ranking.breakdown.usedForUpgrade' | translate }}: {{ lostGamesUpgrade() }}"
      (onChange)="filter.controls.includedUpgrade.setValue($event.checked)"
    />
    <p-togglebutton
      [(ngModel)]="filter.controls.includedDowngrade.value"
      onLabel="{{ 'all.ranking.breakdown.usedForDowngrade' | translate }}: {{ lostGamesDowngrade() }}"
      offLabel="{{ 'all.ranking.breakdown.usedForDowngrade' | translate }}: {{ lostGamesDowngrade() }}"
      (onChange)="filter.controls.includedDowngrade.setValue($event.checked)"
    />
    @if ((system().latestXGamesToUse ?? 0) > 0) {
      <p-togglebutton
        [(ngModel)]="filter.controls.includedIgnored.value"
        onLabel="{{ 'all.ranking.breakdown.notUsed' | translate }}: {{ lostGamesIgnored() }}"
        offLabel="{{ 'all.ranking.breakdown.notUsed' | translate }}: {{ lostGamesIgnored() }}"
        (onChange)="filter.controls.includedIgnored.setValue($event.checked)"
      />
    }
  </div>

  <!-- View Toggles -->
  <div class="flex flex-wrap items-center gap-2">
    <span class="text-sm font-medium text-muted-color mr-2">
      <i class="pi pi-eye text-xs mr-1"></i>
      {{ 'all.ranking.breakdown.show' | translate }}:
    </span>
    <p-togglebutton
      [ngModel]="showUpgrade()"
      onLabel="{{ 'all.ranking.breakdown.show-upgrade' | translate }}"
      offLabel="{{ 'all.ranking.breakdown.show-upgrade' | translate }}"
      (onChange)="showUpgrade.set($event.checked)"
    />
    <p-togglebutton
      [ngModel]="showDowngrade()"
      onLabel="{{ 'all.ranking.breakdown.show-downgrade' | translate }}"
      offLabel="{{ 'all.ranking.breakdown.show-downgrade' | translate }}"
      (onChange)="showDowngrade.set($event.checked)"
    />
  </div>
</div>

<!-- Data Table -->
<div class="overflow-x-auto">
  <p-table [value]="displayGames()" [loading]="loading()" [paginator]="false" styleClass="p-datatable-sm" [scrollable]="true">
    <ng-template pTemplate="header">
      <tr>
        @if (showUpgrade()) {
          <th class="text-center cursor-pointer select-none" style="min-width: 40px" (click)="toggleSort('devideUpgrade')">
            <div class="flex items-center justify-center gap-1">
              # <i class="pi pi-arrow-up text-xs"></i>
              <i class="pi text-xs" [ngClass]="getSortIcon('devideUpgrade')"></i>
            </div>
          </th>
        }
        @if (showDowngrade()) {
          <th class="text-center cursor-pointer select-none" style="min-width: 40px" (click)="toggleSort('devideDowngrade')">
            <div class="flex items-center justify-center gap-1">
              # <i class="pi pi-arrow-down text-xs"></i>
              <i class="pi text-xs" [ngClass]="getSortIcon('devideDowngrade')"></i>
            </div>
          </th>
        }
        <th style="min-width: 40px"></th>
        <th class="cursor-pointer select-none" style="min-width: 140px" (click)="toggleSort('playedAt')">
          <div class="flex items-center gap-1">
            <i class="pi pi-calendar text-xs"></i>
            {{ 'all.ranking.breakdown.date' | translate }}
            <i class="pi text-xs" [ngClass]="getSortIcon('playedAt')"></i>
          </div>
        </th>
        <th style="min-width: 180px">
          <i class="pi pi-users text-xs mr-1"></i>
          {{ 'all.ranking.breakdown.team' | translate }}
        </th>
        <th style="min-width: 180px">
          <i class="pi pi-users text-xs mr-1"></i>
          {{ 'all.ranking.breakdown.opponent' | translate }}
        </th>
        <th class="text-center" style="min-width: 80px">
          <i class="pi pi-star text-xs mr-1"></i>
          {{ 'all.ranking.breakdown.points' | translate }}
        </th>
        @if (showUpgrade()) {
          <th class="text-center" style="min-width: 80px">
            <i class="pi pi-arrow-up text-xs mr-1"></i>
            <span class="hidden md:inline">{{ 'all.ranking.breakdown.usedForUpgrade' | translate }}</span>
          </th>
          <th class="text-center" style="min-width: 100px">
            <i class="pi pi-chart-line text-xs mr-1"></i>
            <span class="hidden md:inline">{{ 'all.ranking.breakdown.upgrade-average' | translate }}</span>
          </th>
        }
        @if (showDowngrade()) {
          <th class="text-center" style="min-width: 80px">
            <i class="pi pi-arrow-down text-xs mr-1"></i>
            <span class="hidden md:inline">{{ 'all.ranking.breakdown.usedForDowngrade' | translate }}</span>
          </th>
          <th class="text-center" style="min-width: 100px">
            <i class="pi pi-chart-line text-xs mr-1"></i>
            <span class="hidden md:inline">{{ 'all.ranking.breakdown.downgrade-average' | translate }}</span>
          </th>
        }
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-game>
      <tr [class.bg-highlight]="game.highestAvgUpgrade || game.highestAvgDowngrade">
        @if (showUpgrade()) {
          <td class="text-center font-medium">
            @if (game.usedForUpgrade) {
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-primary text-primary-contrast text-xs">
                {{ game.countUpgrade }}
              </span>
            }
          </td>
        }
        @if (showDowngrade()) {
          <td class="text-center font-medium">
            @if (game.usedForDowngrade) {
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-orange-500 text-white text-xs">
                {{ game.countDowngrade }}
              </span>
            }
          </td>
        }
        <td class="text-center">
          @if (game.dropsNextPeriod) {
            <i class="pi pi-clock text-orange-500" [pTooltip]="'all.ranking.breakdown.drops-next-period' | translate" tooltipPosition="top"></i>
          }
        </td>
        <td
          class="text-sm text-muted-color cursor-help"
          (mouseenter)="showGameInfo($event, game)"
          (mouseleave)="hideGameInfo()"
        >
          {{ game.playedAt | dayjsFormat: 'DD MMM YYYY HH:mm' }}
        </td>
        <td class="text-sm text-color">
          <div class="flex flex-col gap-0.5">
            @for (player of game.team; track player.gamePlayer?.id) {
              <span>{{ player.gamePlayer?.fullName ?? 'Unknown' }} ({{ player[type()] ?? '?' }})</span>
            }
          </div>
        </td>
        <td class="text-sm text-color">
          <div class="flex flex-col gap-0.5">
            @for (player of game.opponent; track player.gamePlayer?.id) {
              <span>{{ player.gamePlayer?.fullName ?? 'Unknown' }} ({{ player[type()] ?? '?' }})</span>
            }
          </div>
        </td>
        <td class="text-center">
          <span
            class="inline-flex items-center justify-center px-2 py-1 rounded text-sm font-medium"
            [class.text-green-600]="game.points > 0"
            [class.text-red-600]="game.points < 0"
            [class.text-muted-color]="game.points === 0"
          >
            {{ game.points > 0 ? '+' : '' }}{{ game.points }}
          </span>
        </td>
        @if (showUpgrade()) {
          <td class="text-center">
            @if (game.usedForUpgrade) {
              <i class="pi pi-check-circle text-green-500"></i>
            } @else {
              <i class="pi pi-times-circle text-red-500 opacity-50"></i>
            }
          </td>
          <td class="text-center font-medium" [pTooltip]="getTooltip(game, true, game.usedForUpgrade)" tooltipPosition="top">
            @if (game.avgUpgrade) {
              <span
                class="inline-flex items-center justify-center px-2 py-1 rounded text-sm"
                [class.text-green-600]="game.canUpgrade"
                [class.font-bold]="game.highestAvgUpgrade"
                [class.text-yellow-600]="game.highestAvgUpgrade && !game.canUpgrade"
              >
                {{ game.avgUpgrade | number: '1.0-0' }}
              </span>
            }
          </td>
        }
        @if (showDowngrade()) {
          <td class="text-center">
            @if (game.usedForDowngrade) {
              <i class="pi pi-check-circle text-green-500"></i>
            } @else {
              <i class="pi pi-times-circle text-red-500 opacity-50"></i>
            }
          </td>
          <td class="text-center font-medium" [pTooltip]="getTooltip(game, false, game.usedForDowngrade)" tooltipPosition="top">
            @if (game.avgDowngrade) {
              <span
                class="inline-flex items-center justify-center px-2 py-1 rounded text-sm"
                [class.text-red-600]="game.canDowngrade"
                [class.font-bold]="game.highestAvgDowngrade"
                [class.text-yellow-600]="game.highestAvgDowngrade && !game.canDowngrade"
              >
                {{ game.avgDowngrade | number: '1.0-0' }}
              </span>
            }
          </td>
        }
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="showUpgrade() && showDowngrade() ? 11 : showUpgrade() || showDowngrade() ? 9 : 7">
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <i class="pi pi-search text-4xl text-muted-color mb-4"></i>
            <h3 class="text-lg font-semibold text-color mb-2">{{ 'all.ranking.breakdown.games.none' | translate }}</h3>
            <p class="text-muted-color text-sm">{{ 'all.ranking.breakdown.games.noGamesDescription' | translate }}</p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-popover #gameInfoPopover [style]="{ 'pointer-events': 'none' }">
  @if (hoveredGame(); as game) {
    <div class="flex flex-col gap-2 min-w-48 max-w-84">
      <!-- Draw / Home vs Away -->
      @if (game.tournamentDraw?.name) {
        <div class="flex items-center gap-2 text-sm font-medium text-color">
          <i class="pi pi-sitemap"></i>
          <span>{{ game.tournamentDraw?.name }}</span>
        </div>
      } @else if (game.competitionEncounter?.drawCompetition?.name) {
        <div class="flex flex-col gap-1">
          @if (game.competitionEncounter?.homeTeam && game.competitionEncounter?.awayTeam) {
            <div class="flex items-center gap-2 text-sm font-medium text-color">
              <i class="pi pi-users"></i>
              <span>{{ game.competitionEncounter?.homeTeam?.name ?? game.competitionEncounter?.homeTeam?.abbreviation }}</span>
              <span class="text-muted-color">vs</span>
              <span>{{ game.competitionEncounter?.awayTeam?.name ?? game.competitionEncounter?.awayTeam?.abbreviation }}</span>
            </div>
          }
          <div class="flex items-center gap-2 text-xs text-muted-color">
            <i class="pi pi-sitemap"></i>
            <span>{{ game.competitionEncounter?.drawCompetition?.name }}</span>
          </div>
        </div>
      }

      <!-- Event name -->
      @if (game.tournamentDraw?.tournamentSubEvent?.tournamentEvent?.name) {
        <div class="flex items-center gap-2 text-xs text-muted-color">
          <i class="pi pi-map-marker"></i>
          <span>{{ game.tournamentDraw?.tournamentSubEvent?.tournamentEvent?.name }}</span>
        </div>
      } @else if (game.competitionEncounter?.drawCompetition?.competitionSubEvent?.competitionEvent?.name) {
        <div class="flex items-center gap-2 text-xs text-muted-color">
          <i class="pi pi-map-marker"></i>
          <span>{{ game.competitionEncounter?.drawCompetition?.competitionSubEvent?.competitionEvent?.name }}</span>
        </div>
      }

      <!-- Score -->
      @if (hasScores(game)) {
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-trophy text-xs"></i>
          <div class="flex items-center gap-1 tabular-nums">
            @if (isSetPlayed(game.set1Team1, game.set1Team2)) {
              <span class="px-1 rounded"><span [class.text-green-500]="getPlayerSetScore(game, 1) > getOpponentSetScore(game, 1)" [class.text-red-500]="getPlayerSetScore(game, 1) < getOpponentSetScore(game, 1)">{{ getPlayerSetScore(game, 1) }}</span>-{{ getOpponentSetScore(game, 1) }}</span>
            }
            @if (isSetPlayed(game.set2Team1, game.set2Team2)) {
              <span class="px-1 rounded"><span [class.text-green-500]="getPlayerSetScore(game, 2) > getOpponentSetScore(game, 2)" [class.text-red-500]="getPlayerSetScore(game, 2) < getOpponentSetScore(game, 2)">{{ getPlayerSetScore(game, 2) }}</span>-{{ getOpponentSetScore(game, 2) }}</span>
            }
            @if (isSetPlayed(game.set3Team1, game.set3Team2)) {
              <span class="px-1 rounded"><span [class.text-green-500]="getPlayerSetScore(game, 3) > getOpponentSetScore(game, 3)" [class.text-red-500]="getPlayerSetScore(game, 3) < getOpponentSetScore(game, 3)">{{ getPlayerSetScore(game, 3) }}</span>-{{ getOpponentSetScore(game, 3) }}</span>
            }
          </div>
        </div>
      }
    </div>
  }
</p-popover>
